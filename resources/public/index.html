<!DOCTYPE html>
<html lang="pt-BR" class="dark">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Vota√ß√£o Melhores do Ano 2024</title>

  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            'gold': {
              50: '#fefce8',
              100: '#fef9c3',
              200: '#fef08a',
              300: '#fde047',
              400: '#facc15',
              500: '#eab308',
              600: '#ca8a04',
              700: '#a16207',
              800: '#854d0e',
              900: '#713f12',
            },
            'midnight': {
              50: '#f8fafc',
              100: '#f1f5f9',
              200: '#e2e8f0',
              300: '#cbd5e1',
              400: '#94a3b8',
              500: '#64748b',
              600: '#475569',
              700: '#334155',
              800: '#1e293b',
              900: '#0f172a',
              950: '#020617',
            }
          },
          fontFamily: {
            'display': ['Playfair Display', 'serif'],
            'body': ['Inter', 'sans-serif'],
          },
          animation: {
            'pulse-gold': 'pulse-gold 2s cubic-bezier(0.4, 0, 0.6, 1) infinite',
            'reveal': 'reveal 1s ease-out forwards',
            'shimmer': 'shimmer 2s linear infinite',
            'bounce-slow': 'bounce 2s infinite',
          },
          keyframes: {
            'pulse-gold': {
              '0%, 100%': { boxShadow: '0 0 20px rgba(234, 179, 8, 0.4)' },
              '50%': { boxShadow: '0 0 40px rgba(234, 179, 8, 0.8)' },
            },
            'reveal': {
              '0%': { opacity: '0', transform: 'scale(0.8) translateY(20px)' },
              '100%': { opacity: '1', transform: 'scale(1) translateY(0)' },
            },
            'shimmer': {
              '0%': { backgroundPosition: '-200% 0' },
              '100%': { backgroundPosition: '200% 0' },
            }
          }
        }
      }
    }
  </script>

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Playfair+Display:wght@400;500;600;700&display=swap"
    rel="stylesheet">

  <style>
    body {
      font-family: 'Inter', sans-serif;
      background: #000000;
      min-height: 100vh;
    }

    .gradient-text {
      background: linear-gradient(90deg, #fde047, #eab308, #ca8a04);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .glass-card {
      background: rgba(20, 20, 20, 0.9);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .vote-button {
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .vote-button:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 10px 40px rgba(234, 179, 8, 0.3);
    }

    .vote-button:active:not(:disabled) {
      transform: scale(0.98);
    }

    .voted {
      background: linear-gradient(135deg, #eab308, #ca8a04) !important;
      animation: pulse-gold 2s infinite;
    }

    @keyframes confetti {
      0% {
        transform: translateY(0) rotate(0deg);
        opacity: 1;
      }

      100% {
        transform: translateY(100vh) rotate(720deg);
        opacity: 0;
      }
    }

    .confetti {
      position: fixed;
      width: 10px;
      height: 10px;
      top: -10px;
      animation: confetti 3s ease-in-out forwards;
    }
  </style>
</head>

<body class="bg-midnight-950 text-white antialiased">
  <div id="app" class="min-h-screen">
    <!-- Loading state -->
    <div id="loading" class="flex items-center justify-center min-h-screen">
      <div class="text-center">
        <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-gold-400 mx-auto mb-4"></div>
        <p class="text-midnight-400">Conectando ao sistema de vota√ß√£o...</p>
      </div>
    </div>

    <!-- Main content (hidden until connected) -->
    <div id="content" class="hidden"></div>
  </div>

  <script>
    // =============================================================================
    // CONFIGURA√á√ÉO E ESTADO
    // =============================================================================

    const urlParams = new URLSearchParams(window.location.search);
    const perfil = (urlParams.get('perfil') || 'votante').toLowerCase();

    // Session ID persistente
    let sessionId = localStorage.getItem('votacao-session-id');
    if (!sessionId) {
      sessionId = crypto.randomUUID();
      localStorage.setItem('votacao-session-id', sessionId);
    }

    let state = null;
    let ws = null;

    // =============================================================================
    // WEBSOCKET
    // =============================================================================

    function connect() {
      const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
      const wsUrl = `${protocol}//${window.location.host}/?perfil=${perfil}&sessionId=${sessionId}`;

      ws = new WebSocket(wsUrl);

      ws.onopen = () => {
        console.log('üü¢ Conectado ao servidor');
      };

      ws.onmessage = (event) => {
        const msg = JSON.parse(event.data);
        if (msg.type === 'state') {
          state = msg.data;
          render();
        }
      };

      ws.onclose = () => {
        console.log('üî¥ Desconectado. Reconectando em 2s...');
        setTimeout(connect, 2000);
      };

      ws.onerror = (error) => {
        console.error('Erro WebSocket:', error);
      };
    }

    function send(action, data = {}) {
      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({ action, ...data }));
      }
    }

    // =============================================================================
    // RENDERIZA√á√ÉO
    // =============================================================================

    function render() {
      const loading = document.getElementById('loading');
      const content = document.getElementById('content');

      loading.classList.add('hidden');
      content.classList.remove('hidden');

      switch (perfil) {
        case 'admin':
          renderAdmin();
          break;
        case 'apresentador':
          renderApresentador();
          break;
        default:
          renderVotante();
      }
    }

    // =============================================================================
    // VIS√ÉO DO VOTANTE
    // =============================================================================

    function renderVotante() {
      const content = document.getElementById('content');

      if (state.fase !== 'votacao-aberta') {
        content.innerHTML = `
          <div class="flex flex-col items-center justify-center min-h-screen text-center px-8">
            <div class="mb-8">
              <div class="w-24 h-24 rounded-full bg-midnight-800 flex items-center justify-center mx-auto">
                <span class="text-4xl">${getFaseIcon()}</span>
              </div>
            </div>
            
            <h2 class="text-2xl font-bold text-white mb-4">${getFaseTitulo()}</h2>
            <p class="text-midnight-400 text-lg">${getFaseMensagem()}</p>
            
            ${state.fase === 'revelacao' && state.vencedor ? `
              <div class="mt-8 animate-reveal">
                <p class="text-gold-400 text-sm mb-2">Vencedor:</p>
                <p class="text-3xl font-display font-bold gradient-text">${state.vencedor.nome}</p>
              </div>
            ` : ''}
          </div>
        `;
        return;
      }

      // Vota√ß√£o aberta
      content.innerHTML = `
        <div class="min-h-screen pb-8">
          <!-- Header -->
          <header class="pt-8 pb-6 px-6 text-center">
            <h1 class="text-2xl font-display font-bold gradient-text mb-2">üèÜ Melhores do Ano</h1>
            <p class="text-gray-400 text-sm font-body">Vote nos seus favoritos</p>
          </header>
          
          <!-- Main -->
          <main class="px-6">
            <div class="text-center mb-8">
              <span class="inline-block px-4 py-2 rounded-full bg-green-500/20 text-green-400 text-sm font-medium mb-4">
                üü¢ Vota√ß√£o Aberta
              </span>
              <h2 class="text-3xl font-display font-bold gradient-text">${state.categoria.nome}</h2>
              ${state.categoria.descricao ? `<p class="text-gray-400 text-sm mt-2 max-w-md mx-auto font-body">${state.categoria.descricao}</p>` : ''}
            </div>
            
            ${state.jaVotou ? `
              <div class="flex flex-col items-center justify-center py-12 text-center">
                <div class="w-20 h-20 rounded-full bg-gradient-to-br from-gold-400 to-gold-600 
                            flex items-center justify-center mb-6 animate-pulse-gold">
                  <span class="text-3xl text-midnight-950">‚úì</span>
                </div>
                <h3 class="text-xl font-bold gradient-text mb-2">Voto Registrado!</h3>
                <p class="text-midnight-400">Seu voto foi contabilizado com sucesso.</p>
              </div>
            ` : `
              <div class="space-y-4">
                ${state.categoria.candidatos.map(c => `
                  <button 
                    onclick="votar(${c.id})"
                    class="vote-button w-full py-6 px-8 rounded-2xl text-xl font-semibold 
                           glass-card text-white hover:border-gold-400 active:scale-95">
                    ${c.nome}
                  </button>
                `).join('')}
              </div>
            `}
          </main>
        </div>
      `;
    }

    function votar(idCandidato) {
      // Otimistic UI
      state.jaVotou = true;
      render();
      send('votar', { idCandidato });
    }

    // =============================================================================
    // VIS√ÉO DO ADMIN
    // =============================================================================

    function renderAdmin() {
      const content = document.getElementById('content');

      const candidatosOrdenados = [...state.categoria.candidatos].sort((a, b) => {
        return (state.votos[b.id] || 0) - (state.votos[a.id] || 0);
      });

      content.innerHTML = `
        <div class="min-h-screen p-6">
          <!-- Header -->
          <header class="mb-8">
            <div class="flex items-center justify-between flex-wrap gap-4">
              <div>
                <h1 class="text-3xl font-display font-bold gradient-text">üéõÔ∏è Painel Admin</h1>
                <p class="text-gray-500 mt-1 font-body">Controle da Vota√ß√£o</p>
              </div>
              ${renderIndicadorFase()}
            </div>
          </header>
          
          <div class="grid gap-6 lg:grid-cols-2">
            <!-- Controles -->
            <div class="space-y-6">
              <!-- Categoria Atual -->
              <div class="glass-card rounded-2xl p-6">
                <div class="flex items-center justify-between mb-4">
                  <h2 class="text-xl font-bold text-white">Categoria Atual</h2>
                  <span class="text-gray-500 font-body">${state.indiceCategoriaAtual + 1}/${state.totalCategorias}</span>
                </div>
                <h3 class="text-2xl font-display gradient-text mb-2">${state.categoria.nome}</h3>
                ${state.categoria.descricao ? `<p class="text-gray-400 text-sm mb-4 font-body">${state.categoria.descricao}</p>` : ''}
                <div class="flex items-center gap-4 text-gray-400 font-body">
                  <span>üìä Total de votos:</span>
                  <span class="text-2xl font-bold text-gold-400">${state.totalVotos}</span>
                </div>
              </div>
              
              <!-- Controles de Fluxo -->
              <div class="glass-card rounded-2xl p-6">
                <h2 class="text-xl font-bold text-white mb-4">Controles</h2>
                <div class="grid grid-cols-2 gap-4">
                  <button onclick="send('abrir-votacao')" 
                          class="flex items-center justify-center gap-2 px-6 py-3 rounded-xl font-semibold transition-all
                                 ${state.fase === 'aguardando' ? 'bg-green-600 hover:bg-green-500 text-white cursor-pointer hover:scale-105' : 'bg-midnight-800 text-midnight-500 cursor-not-allowed'}"
                          ${state.fase !== 'aguardando' ? 'disabled' : ''}>
                    ‚ñ∂Ô∏è Abrir Vota√ß√£o
                  </button>
                  
                  <button onclick="send('fechar-votacao')"
                          class="flex items-center justify-center gap-2 px-6 py-3 rounded-xl font-semibold transition-all
                                 ${state.fase === 'votacao-aberta' ? 'bg-amber-600 hover:bg-amber-500 text-white cursor-pointer hover:scale-105' : 'bg-midnight-800 text-midnight-500 cursor-not-allowed'}"
                          ${state.fase !== 'votacao-aberta' ? 'disabled' : ''}>
                    ‚èπÔ∏è Fechar Vota√ß√£o
                  </button>
                  
                  <button onclick="send('revelar')"
                          class="flex items-center justify-center gap-2 px-6 py-3 rounded-xl font-semibold transition-all
                                 ${state.fase === 'votacao-fechada' ? 'bg-gradient-to-r from-gold-500 to-gold-600 text-midnight-950 cursor-pointer hover:scale-105' : 'bg-midnight-800 text-midnight-500 cursor-not-allowed'}"
                          ${state.fase !== 'votacao-fechada' ? 'disabled' : ''}>
                    üèÜ Revelar
                  </button>
                  
                  <button onclick="send('proxima')"
                          class="flex items-center justify-center gap-2 px-6 py-3 rounded-xl font-semibold transition-all
                                 ${state.fase === 'revelacao' && state.indiceCategoriaAtual < state.totalCategorias - 1 ? 'bg-blue-600 hover:bg-blue-500 text-white cursor-pointer hover:scale-105' : 'bg-midnight-800 text-midnight-500 cursor-not-allowed'}"
                          ${!(state.fase === 'revelacao' && state.indiceCategoriaAtual < state.totalCategorias - 1) ? 'disabled' : ''}>
                    ‚è≠Ô∏è Pr√≥xima
                  </button>
                </div>
                
                <div class="mt-4 pt-4 border-t border-midnight-700 space-y-3">
                  <button onclick="send('resetar')"
                          class="w-full flex items-center justify-center gap-2 px-6 py-3 rounded-xl font-semibold 
                                 bg-red-600/20 hover:bg-red-600 text-red-400 hover:text-white border border-red-600/50 transition-all">
                    üîÑ Resetar Categoria
                  </button>
                  
                  <button onclick="if(confirm('‚ö†Ô∏è ATEN√á√ÉO!\\n\\nIsso vai apagar TODOS os votos e voltar para a primeira categoria.\\n\\nTem certeza?')) send('resetar-tudo')"
                          class="w-full flex items-center justify-center gap-2 px-6 py-3 rounded-xl font-semibold 
                                 bg-purple-600/20 hover:bg-purple-600 text-purple-400 hover:text-white border border-purple-600/50 transition-all">
                    üóëÔ∏è RESETAR TUDO (Recome√ßar)
                  </button>
                </div>
              </div>
            </div>
            
            <!-- Ranking -->
            <div class="glass-card rounded-2xl p-6">
              <h2 class="text-xl font-bold text-white mb-4">üìä Ranking ao Vivo</h2>
              <div class="space-y-4">
                ${candidatosOrdenados.map((c, i) => {
        const votos = state.votos[c.id] || 0;
        const pct = state.totalVotos > 0 ? Math.round((votos / state.totalVotos) * 100) : 0;
        const cor = i === 0 ? 'from-gold-400 to-gold-600' : i === 1 ? 'from-slate-300 to-slate-400' : i === 2 ? 'from-amber-600 to-amber-700' : 'from-midnight-500 to-midnight-600';
        const badgeCor = i === 0 ? 'bg-gold-500' : i === 1 ? 'bg-slate-400' : i === 2 ? 'bg-amber-600' : 'bg-midnight-600';

        return `
                    <div class="glass-card rounded-xl p-4">
                      <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center gap-3">
                          <span class="w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold ${badgeCor} text-midnight-950">
                            ${i + 1}
                          </span>
                          <span class="font-medium text-white">${c.nome}</span>
                        </div>
                        <div class="text-right">
                          <span class="text-2xl font-bold text-white">${votos}</span>
                          <span class="text-midnight-400 text-sm ml-2">(${pct}%)</span>
                        </div>
                      </div>
                      <div class="w-full h-3 bg-midnight-800 rounded-full overflow-hidden">
                        <div class="h-full bg-gradient-to-r ${cor} transition-all duration-500" style="width: ${pct}%"></div>
                      </div>
                    </div>
                  `;
      }).join('')}
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function renderIndicadorFase() {
      const configs = {
        'aguardando': { cor: 'bg-midnight-600', icone: '‚è≥', texto: 'Aguardando' },
        'votacao-aberta': { cor: 'bg-green-600', icone: 'üü¢', texto: 'Vota√ß√£o Aberta' },
        'votacao-fechada': { cor: 'bg-amber-600', icone: 'üîí', texto: 'Vota√ß√£o Fechada' },
        'revelacao': { cor: 'bg-gold-600', icone: 'üèÜ', texto: 'Revela√ß√£o' }
      };
      const cfg = configs[state.fase] || configs['aguardando'];

      return `
        <div class="inline-flex items-center gap-2 px-4 py-2 rounded-full ${cfg.cor}">
          <span>${cfg.icone}</span>
          <span class="font-medium text-white">${cfg.texto}</span>
        </div>
      `;
    }

    // =============================================================================
    // VIS√ÉO DO APRESENTADOR
    // =============================================================================

    function renderApresentador() {
      const content = document.getElementById('content');

      switch (state.fase) {
        case 'votacao-aberta':
          content.innerHTML = `
            <div class="flex flex-col items-center justify-center min-h-screen text-center px-12">
              <div class="mb-12">
                <div class="inline-flex items-center gap-4 px-8 py-4 rounded-full bg-green-500/20 border-2 border-green-500 animate-pulse">
                  <span class="w-4 h-4 rounded-full bg-green-500"></span>
                  <span class="text-2xl font-bold text-green-400">VOTA√á√ÉO ABERTA</span>
                </div>
              </div>
              
              <h2 class="text-5xl md:text-7xl font-display font-bold gradient-text mb-4">${state.categoria.nome}</h2>
              ${state.categoria.descricao ? `<p class="text-2xl text-gray-400 mb-8 max-w-2xl font-body">${state.categoria.descricao}</p>` : '<div class="mb-8"></div>'}
              
              <div class="space-y-6">
                <p class="text-3xl md:text-4xl text-white font-bold">Vote Agora!</p>
                
                <div class="glass-card rounded-2xl p-8 inline-block">
                  <img src="https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=https://votacao-melhores-do-ano.onrender.com/?perfil=votante" 
                       alt="QR Code para votar" 
                       class="w-48 h-48 rounded-xl bg-white p-2" />
                  <p class="text-sm text-gray-500 mt-3 text-center font-body">Escaneie para votar</p>
                </div>
              </div>
            </div>
          `;
          break;

        case 'votacao-fechada':
          content.innerHTML = `
            <div class="flex flex-col items-center justify-center min-h-screen text-center px-12">
              <div class="mb-12 relative">
                <div class="w-32 h-32 rounded-full border-4 border-midnight-700"></div>
                <div class="absolute inset-0 w-32 h-32 rounded-full border-4 border-transparent border-t-gold-400 animate-spin"></div>
              </div>
              
              <h2 class="text-4xl md:text-5xl font-display text-white mb-6">${state.categoria.nome}</h2>
              <p class="text-2xl text-midnight-400">Contabilizando votos...</p>
              <p class="text-xl text-gold-400 mt-4 animate-pulse">Aguarde a revela√ß√£o</p>
            </div>
          `;
          break;

        case 'revelacao':
          // Confetti effect
          createConfetti();

          content.innerHTML = `
            <div class="flex flex-col items-center justify-center min-h-screen text-center px-12">
              <div class="mb-8">
                <p class="text-2xl text-midnight-400 mb-2">E o vencedor de</p>
                <h3 class="text-3xl md:text-4xl font-display text-white">${state.categoria.nome}</h3>
              </div>
              
              <div class="mb-8 animate-reveal">
                <span class="text-8xl md:text-9xl">üèÜ</span>
              </div>
              
              <div class="animate-reveal" style="animation-delay: 0.3s">
                <h2 class="text-5xl md:text-7xl lg:text-8xl font-display font-bold gradient-text animate-pulse-gold">
                  ${state.vencedor ? state.vencedor.nome : 'Empate!'}
                </h2>
              </div>
              
              <div class="mt-8 flex items-center gap-4 justify-center">
                <span class="text-gold-400 text-4xl">‚ú®</span>
                <span class="text-gold-500 text-5xl">‚≠ê</span>
                <span class="text-gold-400 text-4xl">‚ú®</span>
              </div>
            </div>
          `;
          break;

        default: // aguardando
          content.innerHTML = `
            <div class="flex flex-col items-center justify-center min-h-screen text-center px-12">
              <div class="mb-12">
                <h1 class="text-6xl md:text-8xl font-display font-bold gradient-text mb-4">üèÜ</h1>
                <h2 class="text-4xl md:text-5xl font-display text-white">Melhores do Ano</h2>
              </div>
              
              <div class="glass-card rounded-3xl px-12 py-8">
                <p class="text-2xl text-midnight-400 mb-4">Pr√≥xima Categoria</p>
                <h3 class="text-4xl md:text-6xl font-display font-bold gradient-text">${state.categoria.nome}</h3>
              </div>
            </div>
          `;
      }
    }

    function createConfetti() {
      const colors = ['#fde047', '#eab308', '#ca8a04', '#facc15', '#fef08a'];
      for (let i = 0; i < 50; i++) {
        setTimeout(() => {
          const confetti = document.createElement('div');
          confetti.className = 'confetti';
          confetti.style.left = Math.random() * 100 + 'vw';
          confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
          confetti.style.animationDuration = (Math.random() * 2 + 2) + 's';
          confetti.style.animationDelay = (Math.random() * 0.5) + 's';
          document.body.appendChild(confetti);

          setTimeout(() => confetti.remove(), 5000);
        }, i * 50);
      }
    }

    // =============================================================================
    // HELPERS
    // =============================================================================

    function getFaseIcon() {
      const icons = {
        'aguardando': '‚è≥',
        'votacao-aberta': 'üü¢',
        'votacao-fechada': 'üîí',
        'revelacao': 'üèÜ'
      };
      return icons[state.fase] || '‚è≥';
    }

    function getFaseTitulo() {
      const titulos = {
        'aguardando': 'Aguarde...',
        'votacao-aberta': 'Vote Agora!',
        'votacao-fechada': 'Vota√ß√£o Encerrada',
        'revelacao': 'Resultado Anunciado!'
      };
      return titulos[state.fase] || 'Aguarde...';
    }

    function getFaseMensagem() {
      const mensagens = {
        'aguardando': 'A pr√≥xima categoria ser√° liberada em breve.',
        'votacao-aberta': 'Escolha seu favorito!',
        'votacao-fechada': 'Os votos est√£o sendo contabilizados.',
        'revelacao': `Confira o vencedor de: ${state.categoria.nome}`
      };
      return mensagens[state.fase] || 'Por favor, aguarde.';
    }

    // =============================================================================
    // INICIALIZA√á√ÉO
    // =============================================================================

    connect();
  </script>
</body>

</html>